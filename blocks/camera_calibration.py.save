import numpy as np
import os
import glob

def run(input_dir, output_dir, params=None):
    if not os.path.isdir(input_dir):
        return {
            "status": "error",
            "message": "Input must be a directory of calibration images"
        }

    os.makedirs(output_dir, exist_ok=True)

    chessboard_size = (10, 7)  # inner corners
    square_size = 1.0         # arbitrary unit

    objp = np.zeros((chessboard_size[0] * chessboard_size[1], 3), np.float32)
    objp[:, :2] = np.mgrid[0:chessboard_size[0], 0:chessboard_size[1]].T.reshape(-1, 2)
    objp *= square_size

    objpoints = []
    imgpoints = []

    images = glob.glob(os.path.join(input_dir, "*.jpg"))

    if len(images) == 0:
        return {
            "status": "error",
            "message": "No calibration images found"
        }

    gray = None
    used_images = 0

    for img_path in images:
        img = cv2.imread(img_path)
        if img is None:
            continue

        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        ret, corners = cv2.findChessboardCorners(gray, chessboard_size, None)

        if ret:
            objpoints.append(objp)
            imgpoints.append(corners)
            used_images += 1

    if used_images < 5:
        return {
            "status": "error",
            "message": "Not enough valid chessboard detections (need at least 5)"
        }

    ret, camera_matrix, dist_coeffs, rvecs, tvecs = cv2.calibrateCamera(
        objpoints,
        imgpoints,
        gray.shape[::-1],
        None,
        None
    )

    calib_path = os.path.join(output_dir, "camera_calibration.npz")
    np.savez(calib_path,
             camera_matrix=camera_matrix,
             dist_coeffs=dist_coeffs)

    return {
        "status": "success",
        "metadata": {
            "experiment": "Exp 6 - Camera Calibration",
            "images_used": used_images,
            "reprojection_error": ret
        },
        "output": calib_path
    }
